<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Google Sheets WDC</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
</head>
<body>
  <h1>Google Sheets Web Data Connector</h1>

  <label for="sheetUrl">Masukkan URL CSV Google Sheet kamu:</label><br>
  <input type="text" id="sheetUrl" size="80" placeholder="https://docs.google.com/spreadsheets/.../export?format=csv"><br><br>

  <button onclick="submitWDC()">Connect to Tableau</button>

  <script>
    (function() {
      var myConnector = tableau.makeConnector();

      myConnector.getSchema = function(schemaCallback) {
        const url = document.getElementById("sheetUrl").value;

        fetch(url)
          .then(response => response.text())
          .then(text => {
            const delimiter = detectDelimiter(text);
            const rows = text.split("\n").map(row => row.split(delimiter));
            const headers = rows[0].map(h => h.trim().replace(/^"|"$/g, ""));

            const cols = headers.map(header => ({
              id: header,
              alias: header,
              dataType: tableau.dataTypeEnum.string
            }));

            const tableSchema = {
              id: "GoogleSheetData",
              alias: "Google Sheet Data",
              columns: cols
            };

            schemaCallback([tableSchema]);
          })
          .catch(error => {
            console.error("Error saat mengambil schema:", error);
            tableau.abortWithError("Gagal mengambil schema. Pastikan URL benar dan file tidak kosong.");
          });
      };

      myConnector.getData = function(table, doneCallback) {
        const url = document.getElementById("sheetUrl").value;

        fetch(url)
          .then(response => response.text())
          .then(text => {
            const delimiter = detectDelimiter(text);
            const rows = text.split("\n").map(row => row.split(delimiter));
            const headers = rows[0].map(h => h.trim().replace(/^"|"$/g, ""));

            const data = [];

            for (let i = 1; i < rows.length; i++) {
              const row = rows[i];
              if (row.length !== headers.length) {
                continue;
              }
              const rowData = {};
              headers.forEach((header, index) => {
                rowData[header] = row[index] ? row[index].trim().replace(/^"|"$/g, "") : null;
              });
              data.push(rowData);
            }

            table.appendRows(data);
            doneCallback();
          })
          .catch(error => {
            console.error("Error saat mengambil data:", error);
            tableau.abortWithError("Gagal mengambil data.");
          });
      };

      function detectDelimiter(sampleText) {
        const delimiters = [",", ";", "\t"];
        let maxCount = 0;
        let selected = ",";
        
        delimiters.forEach(d => {
          const count = (sampleText.split("\n")[0].match(new RegExp(`\\${d}`, 'g')) || []).length;
          if (count > maxCount) {
            maxCount = count;
            selected = d;
          }
        });
        return selected;
      }

      tableau.registerConnector(myConnector);
    })();

    function submitWDC() {
      tableau.connectionName = "Google Sheets WDC";
      tableau.submit();
    }
  </script>

</body>
</html>
